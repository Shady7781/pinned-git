#!/bin/bash

# Usage:
# Put pinned-git in your PATH
# alias git=pinned-git


GIT="$(type -p git)"
SELF="$(dirname "$0")"

#export GIT_CURL_VERBOSE=1

# Absolutely necessary to avoid MITM with Apple-patched OpenSSL
# https://hynek.me/articles/apple-openssl-verification-surprises/
export OPENSSL_X509_TEA_DISABLE=1

pinned-git-clone() {
  local cert_name=$1
  shift
  "$GIT" "$cmd" --config "http.sslCAPath=$SELF/emptydir" --config "http.sslCAInfo=$SELF/certs/${cert_name}.crt" "$@"
}

cmd="$1"
shift
if [[ "$cmd" == "clone" || "$cmd" == "cl" ]]; then
  if [[ "$*" == *https://github.com/* ]]; then
    pinned-git-clone github.com "$@"

  elif [[ "$*" == *https://bitbucket.org/* ]]; then
    pinned-git-clone bitbucket.org "$@"

  elif [[ "$*" == *https://code.google.com/* ]]; then
    pinned-git-clone code.google.com "$@"

  elif [[ "$*" == *https://git.gitorious.org/* ]]; then
    pinned-git-clone git.gitorious.org "$@"

  elif [[ "$*" == *https://git.kernel.org/* ]]; then
    pinned-git-clone git.kernel.org "$@"

  elif [[ "$*" == *https://kernel.googlesource.com/* ]]; then
    pinned-git-clone kernel.googlesource.com "$@"

  elif [[ "$*" == *https://chromium.googlesource.com/* ]]; then
    pinned-git-clone chromium.googlesource.com "$@"

  elif [[ "$*" == *https://android.googlesource.com/* ]]; then
    pinned-git-clone android.googlesource.com "$@"

  elif [[ "$*" == *https://git.overlays.gentoo.org/* ]]; then
    pinned-git-clone git.overlays.gentoo.org "$@"

  elif [[ "$*" == *https://alioth.debian.org/* ]]; then
    pinned-git-clone alioth.debian.org "$@"

  elif [[ "$*" == *https://git.eclipse.org/* ]]; then
    pinned-git-clone git.eclipse.org "$@"

  elif [[ "$*" == *https://git.gnome.org/* ]]; then
    pinned-git-clone git.gnome.org "$@"

  elif [[ "$*" == *https://gitlab.com/* ]]; then
    pinned-git-clone gitlab.com "$@"

  else
    "$GIT" "$cmd" "$@"
  fi
else
  "$GIT" "$cmd" "$@"
fi
